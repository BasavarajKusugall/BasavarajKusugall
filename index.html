<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

       <!-- font awesome  -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous" />
    <link rel="stylesheet" href="static/css/AdminLTE.min.css" />

    <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.2.3/css/fixedHeader.dataTables.min.css"  crossorigin="anonymous">
         <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css"  crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.1.0/css/responsive.bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <!-- custom styling -->
    <!-- <link rel="stylesheet" type="text/css" href="style.css"> -->


     <!-- <script src="static/js/jquery.min.js"></script> -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

        <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
        <script src="https://cdn.datatables.net/fixedheader/3.2.3/js/dataTables.fixedHeader.min.js"></script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>

    <title>AEM OSGI Bundles Compare</title>
    <style type="text/css">
.btn_round{
  width: 35px;
  height: 35px;
  display: inline-block;
  border-radius: 50%;
  text-align: center;
  line-height: 35px;
  margin-left: 10px;
  border:1px solid #ccc;
  cursor: pointer;
}
.btn_round:hover{
  color:#fff;
  background:#6b4acc;
  border:1px solid #6b4acc;
}

.btn_content_outer{
display: inline-block;
width: 85%;
}
.close_c_btn{
  width: 30px;
  height: 30px;
  position: absolute;
  right: 10px;
  top: 0px;
  line-height: 30px;
  border-radius: 50%;
  background: #ededed;
  border: 1px solid #ccc;
  color: #ff5c5c;
  text-align: center;
  cursor: pointer;
}

.add_icon{
  padding:10px;
  border: 1px dashed #aaa;
  display: inline-block;
  border-radius: 50%;
  margin-right: 10px;
}
.add_group_btn{
  display: flex;
}
.add_group_btn i{
 font-size: 32px;
 display: inline-block;
 margin-right: 10px;
 
}

.add_group_btn span{
 margin-top: 8px;
}
.add_group_btn, .clone_sub_task{
  cursor: pointer;
}


.sub_task_append_area .custom_square{
  cursor: move;
}

.del_btn_d{
  display: inline-block;
    position: absolute;
    right: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    line-height: 40px;
    text-align: center;
    font-size: 18px;
}
    


      .form-inline {
   
    display: block !important;
    -ms-flex-flow: row wrap;
    flex-flow: row wrap;
    -ms-flex-align: center;
    align-items: center;
}
.dataTables_wrapper .dataTables_length {
    float: right !important;
}
     
      body {
  font-family: calibri;
}

span {
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 18px;
  text-decoration: underline;
  color: blue;
}

table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
  margin-top:10px;
}

td,
th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

th {
  background-color: #ccd;
}

.yellow {
      background-color: yellow !important;
}
.hide {
      display: none !important;
}
.show {
      display: block !important;
}
    </style>
  </head>
  <body >
     


<div class="container py-4">
 <div class="row">
      <div class="col-md-12 form_sec_outer_task border ">
        <div class="row">
          <div class="col-md-12 bg-light p-2 mb-3">
            <div class="row">
              <div class="col-md-6">
                <div class="row">
                  <div class="col-md-6" >
                    <h4 class="frm_section_n">OSGI Bundles Compare</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <label>Server Name</label>
          </div>
          <div class="col-md-4">
            <label> Bundle json </label>
          </div>
        </div>
        <div class="col-md-12 p-0">
          <div class="col-md-12 form_field_outer p-0">
            <div class="row form_field_outer_row" style=" height: 300px; ">
              <div class="form-group col-md-2">
                <input type="text" class="form-control w_90" name="title" id="title_1" placeholder="Server 1"/>
              </div>
              <div class="form-group col-md-9">
                <textarea name="jsonData" id="jsonData" style=" height: 285px; " class="form-control json" ></textarea>
              </div>
              <div class="form-group col-md-1 add_del_btn_outer">
                <button class="btn_round remove_node_btn_frm_field" disabled>
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row ml-0 bg-light mt-3  mx-auto border py-3">
        <div class="col-md-12">
          <button class="btn btn-outline-lite py-0 add_new_frm_field_btn"><i class="fas fa-plus add_icon"></i> Add</button>
        </div>
      </div>
      <div class="row ml-0 bg-light mt-3 mx-auto border py-3">
        <div class="col-md-12">
          <button class="btn btn-outline-lite py-0" id="submit"> Submit</button>
        </div>
      </div>
      
 </div>

</div>
<div class="container-fluid" id="result">
 
  
  </div>
   <div class="row">
    <div class="row ml-0 bg-light mt-3 border py-3 hide">
        <div class="col-md-12">
          <select id="mylist" onchange="myFunction();" class='form-control'>
              <option>All</option>
              <option>Matched</option>
              <option>Mismatch</option>
              <option>Added/Removed Bundles</option>
               <option>Installed</option>
          </select>
        </div>
    </div>
    
    <div class="row ml-0 bg-light mt-3 mx-10 border py-3 hide">
        <div class="col-md-12">
          <button class="btn btn-outline-primary" id="clearall"> CSV</button>
        </div>
    </div>
  </div>



<script type="text/javascript">
function datatableDraw(){
  $("#myTable_wrapper").empty()
   $('#myTable thead tr')
        .clone(true)
        .addClass('filters')
        .appendTo('#myTable thead');

  var table = $('#myTable').DataTable({
        orderCellsTop: true,
        "lengthMenu": [ [10, 25, 50,100, -1], [10, 25, 50,100, "All"] ],
        fixedHeader: true,
        initComplete: function () {
            var api = this.api();
 
            // For each column
            api
                .columns()
                .eq(0)
                .each(function (colIdx) {
                    // Set the header cell to contain the input element
                    var cell = $('.filters th').eq(
                        $(api.column(colIdx).header()).index()
                    );
                    var title = $(cell).text();
                    $(cell).html('<input type="text" placeholder="' + title + '" />');
 
                    // On every keypress in this input
                    $(
                        'input',
                        $('.filters th').eq($(api.column(colIdx).header()).index())
                    )
                        .off('keyup change')
                        .on('change', function (e) {
                            // Get the search value
                            $(this).attr('title', $(this).val());
                            var regexr = '({search})'; //$(this).parents('th').find('select').val();
 
                            var cursorPosition = this.selectionStart;
                            // Search the column for that value
                            api
                                .column(colIdx)
                                .search(
                                    this.value != ''
                                        ? regexr.replace('{search}', '(((' + this.value + ')))')
                                        : '',
                                    this.value != '',
                                    this.value == ''
                                )
                                .draw();
                        })
                        .on('keyup', function (e) {
                            e.stopPropagation();
 
                            $(this).trigger('change');
                            $(this)
                                .focus()[0]
                                .setSelectionRange(cursorPosition, cursorPosition);
                        });
                });
        },
    })

  //Append dropdown and button
  var mylist = $("#mylist").clone();
  var clearall = $("#clearall").clone();
  var myTable_length = $("#myTable_length").parent();
  myTable_length.append(mylist)
  myTable_length.append(clearall)
}

  function arraymove(arr, fromIndex, toIndex) {
    var element = arr[fromIndex];
    arr.splice(fromIndex, 1);
    arr.splice(toIndex, 0, element);
}
  function myFunction() {
  // Declare variables
  var input, filter, table, tr, td, i, txtValue;
  input = document.getElementById("mylist");
  filter = input.value.toUpperCase();
  table = document.getElementById("myTable");
  tr = table.getElementsByTagName("tr");

  // Loop through all table rows, and hide those who don't match the search query
  for (i = 0; i < tr.length; i++) {
    if (!(filter.toUpperCase().indexOf("Added/Removed Bundles".toUpperCase()) > -1)) {
      td = tr[i].getElementsByTagName("td")[tr[i].getElementsByTagName("td").length-1];
      if (td) {
        txtValue = td.textContent || td.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
    if (filter.toUpperCase().indexOf("Added/Removed".toUpperCase()) > -1) {
      var allTd = tr[i].getElementsByTagName("td");
      if (allTd.length) {
         var isAddedRemove = false;
          for (cell = 0; cell < allTd.length; cell++){
            td = tr[i].getElementsByTagName("td")[cell];
            if (td) {
              txtValue = td.textContent || td.innerText;
              if (txtValue.toUpperCase().indexOf("#NA") > -1) {
                isAddedRemove = true;
                
              }
            }
          }
          if (isAddedRemove) {
            tr[i].style.display = "";
          }else{
            tr[i].style.display = "none";
          }
      }
     
      
    }
    if (filter.toUpperCase().indexOf("Installed".toUpperCase()) > -1) {
      var allTd = tr[i].getElementsByTagName("td");
      if (allTd.length) {
         var isAddedRemove = false;
          for (cell = 0; cell < allTd.length; cell++){
            td = tr[i].getElementsByTagName("td")[cell];
            if (td) {
              txtValue = td.textContent || td.innerText;
              if (txtValue.toUpperCase().indexOf(filter.toUpperCase()) > -1) {
                isAddedRemove = true;
                
              }
            }
          }
          if (isAddedRemove) {
            tr[i].style.display = "";
          }else{
            tr[i].style.display = "none";
          }
      }
     
      
    }
    
  }
}

  function filterByMisMatchVersion(el) {
  var input, filter, table, tr, td, i;
  input = document.getElementById("mylist");
  filter = input.value;
  table = document.getElementById("myTable");
  tr = table.getElementsByTagName("tr");
  if (filter.indexOf("Mismatch") > -1) {
    for (i = 0; i < tr.length; i++) {
    if (tr[i].className.indexOf("yellow") > -1) {
         tr[i].className = tr[i].className+" show";
    }else{
      tr[i].className = tr[i].className+" hide";
      
    }
          
    }
  }
  if (filter.indexOf("Matched") > -1) {
    for (i = 0; i < tr.length; i++) {
    if (!tr[i].className.indexOf("yellow") > -1) {
         tr[i].className = tr[i].className+" show";
    }else{
      tr[i].className = tr[i].className+" hide";
      
    }
          
    }
  }
  if (filter.indexOf("All") > -1) {
    for (i = 0; i < tr.length; i++) {
      tr[i].className = tr[i].className+" show";
    }
  }
  
}
  function download_csv(csv, filename) {
    var csvFile;
    var downloadLink;

    // CSV FILE
    csvFile = new Blob([csv], {type: "text/csv"});

    // Download link
    downloadLink = document.createElement("a");

    // File name
    downloadLink.download = filename;

    // We have to create a link to the file
    downloadLink.href = window.URL.createObjectURL(csvFile);

    // Make sure that the link is not displayed
    downloadLink.style.display = "none";

    // Add the link to your DOM
    document.body.appendChild(downloadLink);

    // Lanzamos
    downloadLink.click();
}

function export_table_to_csv(html, filename) {
  var csv = [];
  var rows = document.querySelectorAll("table tr");
  
    for (var i = 0; i < rows.length; i++) {
    var row = [], cols = rows[i].querySelectorAll("td, th");
    
        for (var j = 0; j < cols.length; j++) 
            row.push(cols[j].innerText);
        
    csv.push(row.join(","));    
  }

    // Download CSV
    download_csv(csv.join("\n"), filename);
}

document.querySelector("#clearall").addEventListener("click", function () {
    var html = document.querySelector("table").outerHTML;
  export_table_to_csv(html, "table.csv");
});

 // Create table
        function createTable(data) {

            // Check if at least one value exists in the json array
            if(data.length > 0 && Array.isArray(data)){
                
                // Get div to create table
                var mytable = document.getElementById("result");
                $("#result").empty();
                
                // Clear table if exists
                var t = document.getElementById("myTable");
                if(t){
                    t.remove();
                }

                // Create table 
                var table = document.createElement('table');
                table.setAttribute('id', 'myTable');
                table.setAttribute("border", "1");
                table.className="table-fit"
                table.style.borderCollapse = "collapse";
                table.appendChild(createTHead(data));
                table.appendChild(createTBody(data));
                mytable.appendChild(table);
                datatableDraw();


            }
        }

        // Create table head
        function createTHead(data){
            var keys = Object.keys(data[0]);
            var symbolicNameIndex = keys.indexOf("symbolicName")
            if (symbolicNameIndex>-1) {
              arraymove(keys,symbolicNameIndex,0)
            }
            var bundleIndex = keys.indexOf("Bundle")
            if (bundleIndex>-1) {
              arraymove(keys,bundleIndex,1)
            }

            var thead = document.createElement('thead');
            var tr = document.createElement('tr');

            var thId = document.createElement('th');
                thId.appendChild(document.createTextNode("No."));
                tr.appendChild(thId);

            for (var col = 0; col < keys.length; col++) {
                var th = document.createElement('th');
                th.appendChild(document.createTextNode(keys[col]));
                tr.appendChild(th);
            }
            var th = document.createElement('th');
                th.appendChild(document.createTextNode("result"));
                tr.appendChild(th);
                th.className = "hide";
            thead.appendChild(tr);
            return thead;
        }

        // Create table body
        function createTBody(data){
            var keys = Object.keys(data[0]);

            var symbolicNameIndex = keys.indexOf("symbolicName")
            if (symbolicNameIndex>-1) {
              arraymove(keys,symbolicNameIndex,0)
            }
            var bundleIndex = keys.indexOf("Bundle")
            if (bundleIndex>-1) {
              arraymove(keys,bundleIndex,1)
            }


            var tbody = document.createElement('tbody');
            for (var row = 0; row < data.length; row++) {
                var tr = document.createElement('tr');
                var versions = [];
                var tdId = document.createElement('td');
                    tdId.appendChild(document.createTextNode((row+1)));
                    tr.appendChild(tdId);
                for (var col = 0; col < keys.length; col++) {
                    if (keys[col].startsWith("Version")) {
                      if (!versions.includes(data[row][keys[col]])) {
                          versions.push(data[row][keys[col]])
                      }
                      
                    }
                    var td = document.createElement('td');
                    td.appendChild(document.createTextNode(data[row][keys[col]] ? data[row][keys[col]] : "#NA"));
                    tr.appendChild(td);
                }
                if (versions.length >1) {
                    var td = document.createElement('td');
                    td.appendChild(document.createTextNode("All,Mismatch"));
                    tr.appendChild(td);
                    td.className = "hide";
                    tr.className = "yellow mismatch-version";
                  console.log("different version")
                }else{
                  var td = document.createElement('td');
                    td.appendChild(document.createTextNode("All,Matched"));
                    tr.appendChild(td);
                    td.className = "hide";
                 
                }
                tbody.appendChild(tr);
            }
            return tbody;
        }


$(document).ready(function(){
  
    $("#result").hide();
    $("body").on("click",".add_new_frm_field_btn", function (){ 
      console.log("clicked");
      var index = $(".form_field_outer").find(".form_field_outer_row").length + 1;
      $(".form_field_outer").append(`
          <div class="row form_field_outer_row" style=" height: 300px; ">
              <div class="form-group col-md-2">
                <input type="text" class="form-control w_90" name="title" id="title_${index}" placeholder="Server ${index}" />
              </div>
              <div class="form-group col-md-9">
                <textarea name="jsonData" id="jsonData_${index}" class="form-control json" style=" height: 285px; " ></textarea>
              </div>
              <div class="form-group col-md-1 add_del_btn_outer">
                <button class="btn_round remove_node_btn_frm_field" disabled>
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
        `);

      $(".form_field_outer").find(".remove_node_btn_frm_field:not(:first)").prop("disabled", false);
      $(".form_field_outer").find(".remove_node_btn_frm_field").first().prop("disabled", true);
    });

    $("body").on("click","#submit", function (){ 
      console.log("Submit");
       
       var totalFields = $(".form_field_outer").find(".form-control.json").length;
       console.log(totalFields);
       var jsonElements = $(".form_field_outer").find(".form-control.json")
       var allData = [];
       var allSymbols = [];
       for (let i = 0; i < totalFields; i++) {

         var valStr =  jsonElements[i].value
         if (valStr) {
            try{
                var indx = (i+1)
                var titleEl = $("#title_"+indx)
                var title = "Server_"+indx
                if (titleEl && $(titleEl).val()) {
                  title = $(titleEl).val()
                }
                var jsonData = JSON.parse(valStr)
                if(jsonData){

                  jsonData.title = title;
                  var data = jsonData.data;
                  data.forEach((item) => {
                   
                    if (!allSymbols.includes(item.symbolicName)) {
  
                      allSymbols.push(item.symbolicName);
                    }
                  }); 
                  allData.push(jsonData);
                }

            }catch(e){
              console.log(e)
              alert("Unable to parse json data")
            }

          
         }else{
           alert("Enter bundle json data")
         }
          
        }
        
        //console.log(allData)
        console.log(allSymbols)

        var mm = []
        allSymbols.forEach((symb) => {
           allData.forEach((oneData,index) =>{
              var row = {};
              if(mm.find(item=>item.symbolicName==symb)){
                row = mm.find(item=>item.symbolicName==symb)
              }
              
              var found = oneData.data.find(item=>item.symbolicName==symb);
              if (found) {
                row["Title_"+oneData.title] = oneData.title;
                row.symbolicName = found.symbolicName;
                row["State_"+oneData.title]= found.state;
                row["Version_"+oneData.title] = found.version;
                row.Bundle = found.name;
                if(!mm.find(item=>item.symbolicName==symb)){
                   mm.push(row)
                }
              }
              
             
           })         
                    
        }); 


        console.log(mm)
        //Valid data found
        if(mm.length){
            createTable(mm)
            $("#result").show();
        }
    });
    




    $("body").on("click","#clearall", function (){ 
      console.log("clearall");
    });
 });




$(document).ready(function(){
    //===== delete the form fieed row
    $("body").on("click", ".remove_node_btn_frm_field", function () {
      $(this).closest(".form_field_outer_row").remove();
      console.log("success");
    });
  });



</script>
    

   
  </body>
</html>
